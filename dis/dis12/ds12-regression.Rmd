---
title: "STAT 240 Discussion 12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(lubridate)
source("../../scripts/viridis.R")
source("../../scripts/ggprob.R")
```


## Questions

## Data

The following code reads in the official Madison weather data and calculates the average winter temperature (November through February) for each winter and graphs the data and a fitted linear model.

**NOTE:** Usually, you need to be very careful about using time as a predictor like this, but here we have summarised it into an average annual temperature, which should have less longitudinal dependence issues, and we're just using a familiar dataset as a regression demo.


```{r read-data}
## Read and transform the Madison weather data
mw_orig = read_csv("../../data/madison-weather-official-1869-2022.csv")

mw = mw_orig %>% 
  mutate(year = year(date),
         month = month(date, label = TRUE),
         .after = date) %>% 
  mutate(year1 = case_when(
    month > "Jun" ~ year,
    month < "Jul" ~ year - 1),
    year2 = year1 + 1,
    winter = str_c(year1, "-", year2),
    .before = year) 

## add the winter variables and filter
mw_winter = mw %>%
  filter(month %in% c("Nov", "Dec", "Jan", "Feb")) %>%
  select(-prcp, -contains("snow")) %>% 
  drop_na() %>% 
  filter(winter >= "1869-1870" & winter <= "2019-2020") %>% 
  group_by(winter, year1) %>%
  summarize(tavg = mean(tavg))
```

## Setup

### Scatter plot and regression line

```{r plot-data}
ggplot(mw_winter, aes(x = year1, y = tavg)) +
  geom_point() +
  geom_smooth(method = "lm", se=FALSE) +
  xlab("Year (first year of the winter)") +
  ylab("Average Winter Temperature") +
  ggtitle("Madison, WI Average Winter Temperature",
          subtitle = "Winter defined as Nov. through Feb.") +
  theme_bw()
```

### Regression Model

The next block of code fits a linear model and then adds the residuals and predicted values as new columns for plotting purposes later on.

```{r fit-regression-model}
## fit the regression model
winter_lm = lm(tavg ~ year1, data = mw_winter)

## get summary table of coefficients and inference values
summary(winter_lm)

## augment data frame with  residuals and fitted values for plotting later
mw_winter_aug = mw_winter %>% mutate()
mw_winter_aug$.resid = resid(winter_lm)
mw_winter_aug$.pred = fitted(winter_lm)

head(mw_winter_aug)
```


## Problems


### 1 

Using the results of the linear model fit above, write out the estimated linear model by replacing the (a) and (b) with the estimated coefficients; y_hat represents the estimated average winter temperature in Madison for year x.  What is the interpretation of the estimated slope?

y_hat = -13.20748 + 0.01934 * x

The slope is the estimated change in average winter temperature in Madison per year.

### 2

### 2A

Calculate the end points of a 95% confidence interval for the slope of the regressions model.
Note that we have data for this entire period of time,
so a confidence interval here represents the slope in a linear unseen climate trend whereas the data is affected by the randomness of weather.

Round the margin of error to two significant digits and then round the estimated slope to the same accuracy.
The margin of error is the product of a quantile from a t distribution with an appropriate number of degrees of freedom.

```{r}

# get the t quantile
t_quantile = qt(0.975, df = nrow(mw_winter_aug) - 2)

# get the standard error
se_slope = summary(winter_lm)$coefficients[2, 2]

# get the margin of error
moe = t_quantile * se_slope

# get the estimated slope
slope = summary(winter_lm)$coefficients[2, 1]

# get the end points of the confidence interval
ci = slope + c(-1, 1) * moe

# round the margin of error and slope to two significant digits
moe = round(moe, 2)

slope = round(slope, 2)

# round the confidence interval to two significant digits
ci = round(ci, 2)

# print the results
cat("The estimated slope is", slope, "with a 95% confidence interval of (", ci[1], ",", ci[2], ").\n")
```


### 2B

Interpret this confidence interval in context, following examples from lecture.

We are 95% confident that the true slope of the regression line of average winter temperature in Madison due to a changing climate is between 0.01 and 0.03.


### 3

Is there strong evidence that the unknown slope of the regression line of average winter temperature in Madison due to a changing climate is different from zero?

There is strong evidence that the unknown slope of the regression line of average winter temperature in Madison due to a changing climate is different from zero because the p-value is less than 0.05 (p = 0.004363)

### 3A

Report a t-test statistic and p-value from the model summary output.

The t-test statistic is 2.895 and the p-value is 0.004363.


### 3B

Verify the calculation of the p-value using the `pt()` function.

```{r}
# get the t-test statistic'
t_stat = summary(winter_lm)$coefficients[2, 3]

# get the p-value
p_value = 2 * pt(t_stat, df = nrow(mw_winter_aug) - 2, lower.tail = FALSE)

# print the results
cat("The t-test statistic is", t_stat, "and the p-value is", p_value, ".\n")
```


### 3C

Interpret this hypothesis test in the context of the question.

We have strong evidence that the true slope of the regression line of average winter temperature in Madison due to a changing climate is different from zero because the p-value is less than 0.05 (p = 0.004363). Therefore, we have strong evidence that the average winter temperature in Madison is increasing due to a changing climate. For every year, the average winter temperature in Madison is increasing by 0.01934 degrees Fahrenheit. We may reject the null hypothesis that the true slope of the regression line of average winter temperature in Madison due to a changing climate is zero.

